# Technical Architecture Document
## K12 STEM Learning AI Playground

**Version:** 1.0
**Date:** January 27, 2026
**Status:** Draft
**Authors:** Development Team

---

## Table of Contents

1. [Executive Summary](#executive-summary)
2. [System Overview](#system-overview)
3. [Technology Stack](#technology-stack)
4. [Architecture Diagrams](#architecture-diagrams)
5. [Project Structure](#project-structure)
6. [Database Schema](#database-schema)
7. [API Design](#api-design)
8. [External Service Integrations](#external-service-integrations)
9. [Security & Authentication](#security--authentication)
10. [State Management](#state-management)
11. [Performance & Optimization](#performance--optimization)
12. [Deployment Architecture](#deployment-architecture)
13. [Cost Analysis](#cost-analysis)
14. [Development Workflow](#development-workflow)
15. [Appendix](#appendix)

---

## Executive Summary

This document outlines the technical architecture for an AI-powered K12 STEM learning platform that generates personalized, interactive educational experiences. The system leverages:

- **Next.js 16** with React 19 for a modern, server-rendered application
- **tRPC v11** for type-safe API communication
- **Drizzle ORM** with **Neon PostgreSQL** for scalable data storage
- **Better Auth** for secure authentication (email/password + Google OAuth)
- **Google Gemini** for content generation (stories, scenes, GeoGebra XML, lyrics)
- **ElevenLabs** for high-quality text-to-speech
- **Suno AI** for scene-specific background music
- **GeoGebra** for interactive mathematical visualizations
- **ShadCN UI** for accessible, modern components

The architecture prioritizes real-time AI content generation while caching results to optimize performance and cost. The system is designed for desktop-first usage with responsive fallbacks for mobile/tablet.

---

## System Overview

### Core Philosophy

1. **Type Safety**: End-to-end TypeScript from database to frontend
2. **AI-First**: All content dynamically generated by AI (no pre-made lessons)
3. **Real-Time Generation**: Generate lessons on-demand, cache for reuse
4. **Desktop-First**: Optimize for laptops/desktops with GeoGebra in mind
5. **Progressive Enhancement**: Core functionality works without advanced features

### Key Features

- **Interactive Prompt Interface**: ChatGPT-like home page for lesson requests
- **AI-Generated Storytelling**: Multi-scene narratives explaining STEM concepts
- **Adaptive Complexity**: Elementary, Middle, High school levels
- **Interactive Playgrounds**: GeoGebra-powered simulations
- **AI Narration**: High-quality TTS with auto-advance
- **Embedded Assessments**: Quizzes within scenes
- **Resource Tabs**: Objectives, Glossary, AI Consultant
- **Sharing**: Simple link-based lesson sharing

---

## Technology Stack

### Frontend

| Technology | Version | Purpose |
|------------|----------|---------|
| **Next.js** | 16.0.3 | React framework with App Router, Server Components |
| **React** | 19.2.0 | UI library with latest features (Actions, Concurrent) |
| **TypeScript** | 5.x | Type safety across codebase |
| **Tailwind CSS** | 4.x | Utility-first styling |
| **ShadCN UI** | Latest | Pre-built accessible components |
| **Framer Motion** | Latest | Smooth animations (optional) |
| **TanStack Query** | 5.90.10 | Data fetching and caching |
| **react-geogebra** | 1.2.5 | GeoGebra embedding |

### Backend

| Technology | Version | Purpose |
|------------|----------|---------|
| **tRPC** | 11.7.1 | End-to-end type-safe API |
| **Drizzle ORM** | 0.44.7 | Type-safe database queries |
| **Neon Serverless** | 1.0.2 | PostgreSQL cloud database |
| **Better Auth** | 1.4.1 | Authentication (email/password + OAuth) |
| **Zod** | 4.1.12 | Schema validation |
| **SuperJSON** | 2.2.5 | JSON serialization for tRPC |

### AI & External Services

| Service | Integration Type | Purpose |
|---------|-----------------|---------|
| **Google Gemini API** | REST/SDK | Generate: stories, scenes, GeoGebra XML, lyrics |
| **ElevenLabs** | REST | Text-to-speech for narration |
| **Suno AI** | REST | Scene-specific background music |
| **GeoGebra CDN** | Script Embed | Mathematical visualizations |

### Development Tools

| Tool | Purpose |
|------|---------|
| **Biome** | Linting and formatting |
| **Husky** | Git hooks (pre-commit) |
| **Commitlint** | Conventional commits |
| **Drizzle Kit** | Database migrations |
| **TypeScript Compiler** | Type checking |

---

## Architecture Diagrams

### High-Level System Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         CLIENT LAYER                                 │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    Next.js App Router                         │    │
│  │                                                             │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐              │    │
│  │  │   Home   │  │  Lesson   │  │Playground│              │    │
│  │  │  Page    │  │   Page   │  │   Page   │              │    │
│  │  └──────────┘  └──────────┘  └──────────┘              │    │
│  │       │              │              │                         │    │
│  │       └──────────────┴──────────────┘                         │    │
│  │                      │                                        │    │
│  │               ┌──────▼──────┐                                 │    │
│  │               │  tRPC       │                                 │    │
│  │               │   Client     │                                 │    │
│  │               └─────────────┘                                 │    │
│  └────────────────────────┬────────────────────────────────────────────┘    │
└─────────────────────────┼────────────────────────────────────────────────┘
                          │
                          │ HTTP/JSON (SuperJSON)
                          │
┌─────────────────────────▼─────────────────────────────────────────────────┐
│                         SERVER LAYER                                 │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    Next.js API Routes                           │    │
│  │                                                             │    │
│  │               ┌──────▼──────┐                                 │    │
│  │               │  tRPC       │                                 │    │
│  │               │   Router     │                                 │    │
│  │               └─────────────┘                                 │    │
│  │                      │                                        │    │
│  │       ┌──────────────┼──────────────┐                        │    │
│  │       │              │              │                        │    │
│  │  ┌────▼────┐  ┌───▼─────┐  ┌───▼──────┐              │    │
│  │  │ Lessons  │  │   AI     │  │  Media   │              │    │
│  │  │ Router   │  │ Router   │  │  Router  │              │    │
│  │  └────┬────┘  └───┬─────┘  └───┬──────┘              │    │
│  │       │              │              │                        │    │
│  └───────┼──────────────┼────────────┼────────────────────────┘    │
└──────────┼──────────────┼────────────┼──────────────────────────────┘
           │              │            │
    ┌──────▼────────┐ ┌─▼──────────▼──┐ ┌──▼─────────┐
    │  Drizzle ORM  │ │  AI Services   │ │  Better    │
    │              │ │  (External)    │ │   Auth     │
    └──────┬───────┘ └────────────────┘ └────────────┘
           │
    ┌──────▼──────────────────┐
    │     Neon PostgreSQL     │
    │  (User Data + Content) │
    └─────────────────────────┘
           ▲
           │
    ┌──────┴──────────────────┐
    │  AI Generated Content   │
    │  (Cached in DB)       │
    └───────────────────────┘

External Services:
• Gemini API (story/scenes/GeoGebra/lyrics)
• ElevenLabs (text-to-speech)
• Suno AI (scene music)
• GeoGebra CDN (embed scripts)
```

### Data Flow: Lesson Generation

```
┌──────────────┐
│    User      │ Enters prompt + selects complexity
│  (Browser)   │
└──────┬───────┘
       │
       │ tRPC Mutation: ai.generateLesson
       │
┌──────▼──────────────────────────────────┐
│         Server: AI Pipeline            │
│                                      │
│  1. Validate prompt (Zod)           │
│  2. Call Gemini: generateOutline      │
│     → Returns: story structure,       │
│        scene breakdown, topics        │
│                                      │
│  3. For each scene:                  │
│     a. Generate story text            │
│     b. Generate GeoGebra XML         │
│     c. Generate quiz questions       │
│     d. Generate lyrics              │
│     e. Call ElevenLabs: generateAudio│
│     f. Call Suno: generateMusic     │
│                                      │
│  4. Save to DB:                    │
│     - lessons table                  │
│     - scenes table (bulk insert)      │
│     - quiz_questions table            │
│                                      │
└──────┬──────────────────────────────────┘
       │
       │ Returns lessonId
       │
┌──────▼───────┐
│   User       │ Redirects to /lesson/[lessonId]
│ (Browser)    │
└──────────────┘
```

### Data Flow: Scene Playback

```
┌──────────────┐
│    User      │ Loads /lesson/[lessonId]/scene/[sceneNumber]
│  (Browser)   │
└──────┬───────┘
       │
       │ tRPC Query: lessons.getScene(sceneId)
       │
┌──────▼──────────────────────────────────┐
│              Server                  │
│                                      │
│  1. Fetch scene from DB               │
│  2. Fetch quiz questions (if any)      │
│  3. Return scene data (pre-generated) │
│                                      │
└──────┬──────────────────────────────────┘
       │
       │ Returns: { scene, audioUrl, musicUrl, quiz }
       │
┌──────▼──────────────────────────────────┐
│         Browser                   │
│                                      │
│  1. Render Scene Card:                │
│     - Image (placeholder or DALL-E)    │
│     - Text content                    │
│     - Audio player (ElevenLabs)       │
│     - Music player (Suno)             │
│                                      │
│  2. Auto-advance Logic:               │
│     - On TTS complete → Next scene    │
│     - Or wait for manual "Next" click │
│                                      │
│  3. Quiz Display (if present):        │
│     - Multiple choice / Open-ended      │
│     - On submit → Save to DB         │
│     - Show explanation                │
│                                      │
└──────────────────────────────────────────┘
```

---

## Project Structure

```
src/
├── app/
│   ├── (marketing)/                 # Public marketing pages
│   │   ├── page.tsx               # Landing page
│   │   ├── about/
│   │   └── layout.tsx
│   │
│   ├── (app)/                     # Authenticated application
│   │   ├── home/                  # Home page (ChatGPT-like)
│   │   │   └── page.tsx         # Prompt input + gallery
│   │   │
│   │   ├── lesson/                # Lesson/scene pages
│   │   │   ├── [lessonId]/
│   │   │   │   ├── page.tsx       # Scene player
│   │   │   │   └── scene/[sceneNumber]/
│   │   │   │       └── page.tsx   # Individual scene
│   │   │   └── layout.tsx
│   │   │
│   │   ├── playground/             # GeoGebra playground
│   │   │   ├── [lessonId]/
│   │   │   │   └── page.tsx
│   │   │   └── layout.tsx
│   │   │
│   │   ├── shared/               # Public shared lessons
│   │   │   └── [shareToken]/
│   │   │       └── page.tsx
│   │   │
│   │   ├── dashboard/             # User dashboard
│   │   │   ├── page.tsx         # Profile + saved content
│   │   │   └── lessons/
│   │   │       └── page.tsx     # Lesson history
│   │   │
│   │   └── layout.tsx            # App shell with nav
│   │
│   ├── api/
│   │   ├── auth/[...all]/route.ts # Better Auth handler
│   │   └── trpc/[trpc]/route.ts  # tRPC edge handler
│   │
│   ├── layout.tsx                # Root layout
│   ├── globals.css
│   └── favicon.ico
│
├── components/
│   ├── ui/                       # ShadCN components (generated)
│   │   ├── button.tsx
│   │   ├── card.tsx
│   │   ├── input.tsx
│   │   ├── textarea.tsx
│   │   ├── select.tsx
│   │   ├── tabs.tsx
│   │   ├── dialog.tsx
│   │   ├── progress.tsx
│   │   ├── avatar.tsx
│   │   ├── separator.tsx
│   │   ├── badge.tsx
│   │   └── toast.tsx
│   │
│   ├── home/                     # Home page components
│   │   ├── prompt-input.tsx       # ChatGPT-like input + complexity selector
│   │   ├── gallery-grid.tsx       # Public templates/lessons
│   │   ├── template-card.tsx      # Individual template
│   │   └── complexity-selector.tsx # Elementary/Middle/High
│   │
│   ├── lesson/                   # Lesson/scene components
│   │   ├── scene-card.tsx         # Visual + text per scene
│   │   ├── scene-navigation.tsx   # Next/Prev buttons + auto-advance
│   │   ├── audio-player.tsx       # ElevenLabs TTS controls
│   │   ├── music-player.tsx       # Suno music controls
│   │   ├── quiz-card.tsx          # Quiz UI
│   │   ├── ├── quiz-multiple-choice.tsx
│   │   ├── ├── quiz-open-ended.tsx
│   │   ├── progress-bar.tsx       # Lesson progress indicator
│   │   └── scene-image.tsx        # Scene visualization
│   │
│   ├── playground/                # Playground components
│   │   ├── geogebra-embed.tsx    # GeoGebra wrapper component
│   │   ├── resource-tabs.tsx      # Tab navigation
│   │   ├── objectives-panel.tsx    # Tab 1: Goals + hints
│   │   ├── glossary-panel.tsx      # Tab 2: Formulas + terms
│   │   ├── consultant-chat.tsx      # Tab 3: AI Q&A
│   │   └── playground-toolbar.tsx   # Save/reset controls
│   │
│   ├── shared/                   # Shared components
│   │   ├── nav-bar.tsx           # Main navigation
│   │   ├── footer.tsx
│   │   ├── share-modal.tsx        # Simple sharing dialog
│   │   ├── loading-spinner.tsx
│   │   ├── error-boundary.tsx
│   │   └── user-menu.tsx
│   │
│   └── auth/                     # Auth components (existing)
│       ├── auth-form.tsx
│       └── user-profile.tsx
│
├── lib/
│   ├── ai/                       # AI Service Layer
│   │   ├── gemini/
│   │   │   ├── client.ts         # Gemini API client initialization
│   │   │   ├── prompts.ts        # Prompt templates for various tasks
│   │   │   ├── generators.ts     # Main generation functions
│   │   │   ├── types.ts         # Type definitions
│   │   │   └── stream.ts        # Streaming response handler
│   │   │
│   │   ├── elevenlabs/
│   │   │   ├── client.ts         # ElevenLabs API client
│   │   │   ├── types.ts
│   │   │   └── voices.ts         # Voice configuration
│   │   │
│   │   └── suno/
│   │       ├── client.ts          # Suno API client
│   │       ├── types.ts
│   │       └── status.ts         # Polling generation status
│   │
│   ├── db/
│   │   ├── index.ts              # Drizzle client initialization
│   │   ├── schema/
│   │   │   ├── users.ts          # Better Auth (existing)
│   │   │   ├── lessons.ts        # Lessons table
│   │   │   ├── scenes.ts         # Scenes table
│   │   │   ├── quizzes.ts        # Quiz questions
│   │   │   ├── quiz-responses.ts # User answers
│   │   │   ├── playgrounds.ts    # Saved GeoGebra configs
│   │   │   └── shared.ts        # Shared lessons metadata
│   │   └── migrations/           # SQL migration files
│   │
│   ├── auth/
│   │   ├── index.ts              # Better Auth configuration
│   │   ├── schema.ts             # Auth schema
│   │   └── client.ts            # Auth client
│   │
│   ├── server/
│   │   ├── trpc.ts              # tRPC initialization + middleware
│   │   └── routers/
│   │       ├── _app.ts           # Root router
│   │       ├── lessons.ts         # Lesson procedures
│   │       ├── ai.ts             # AI generation procedures
│   │       ├── media.ts          # Audio/music procedures
│   │       ├── quizzes.ts        # Quiz procedures
│   │       ├── playgrounds.ts     # Playground procedures
│   │       └── users.ts         # User procedures (existing)
│   │
│   ├── trpc/
│   │   ├── client.tsx            # tRPC browser client
│   │   ├── server.tsx            # tRPC server client (RSC)
│   │   └── context.ts           # tRPC context creation
│   │
│   ├── validators/               # Zod schemas
│   │   ├── lesson.ts
│   │   ├── quiz.ts
│   │   └── playground.ts
│   │
│   └── utils/
│       ├── constants.ts           # App constants
│       ├── helpers.ts            # Utility functions
│       └── formatters.ts         # Data formatting
│
├── hooks/
│   ├── use-lesson.ts            # Lesson state management
│   ├── use-scene.ts             # Scene navigation logic
│   ├── use-tts.ts              # TTS controls (ElevenLabs)
│   ├── use-music.ts            # Music controls (Suno)
│   ├── use-geogebra.ts         # GeoGebra interactions
│   ├── use-quiz.ts             # Quiz state
│   └── use-share.ts            # Sharing logic
│
├── types/
│   ├── lesson.ts               # Shared lesson types
│   ├── scene.ts                # Scene types
│   ├── quiz.ts                 # Quiz types
│   └── ai.ts                  # AI service types
│
├── styles/
│   └── animations.css          # Custom animations (Framer Motion fallback)
│
└── config/
    └── ai-config.ts           # AI service configuration
```

---

## Database Schema

### Core Tables

#### lessons
```typescript
import { pgTable, serial, text, integer, timestamp, boolean, jsonb } from "drizzle-orm/pg-core";

export const lessonsTable = pgTable("lessons", {
  id: serial("id").primaryKey(),
  userId: integer("user_id")
    .notNull()
    .references(() => usersTable.id, { onDelete: "cascade" }),

  // Lesson metadata
  title: text("title").notNull(),
  subject: text("subject").notNull(),           // "physics", "mathematics", "chemistry"
  topic: text("topic").notNull(),             // "archimedes principle", "gravity"
  complexity: text("complexity").notNull(),    // "elementary" | "middle" | "high"

  // User input
  userPrompt: text("user_prompt").notNull(),   // Original user request

  // Sharing
  isPublic: boolean("is_public").notNull().default(false),
  shareToken: text("share_token").unique(),      // For share links

  // AI metadata (optional, for debugging)
  geminiPrompt: jsonb("gemini_prompt"),        // Store prompts used
  geminiResponse: jsonb("gemini_response"),    // Full AI response (cache)

  // Timestamps
  createdAt: timestamp("created_at").notNull().defaultNow(),
  updatedAt: timestamp("updated_at")
    .notNull()
    .$onUpdate(() => new Date()),
});

export type InsertLesson = typeof lessonsTable.$inferInsert;
export type SelectLesson = typeof lessonsTable.$inferSelect;
```

#### scenes
```typescript
export const scenesTable = pgTable("scenes", {
  id: serial("id").primaryKey(),
  lessonId: integer("lesson_id")
    .notNull()
    .references(() => lessonsTable.id, { onDelete: "cascade" }),

  // Scene order
  sceneNumber: integer("scene_number").notNull(),

  // Content
  title: text("title").notNull(),
  content: text("content").notNull(),         // Story text

  // Media
  imageUrl: text("image_url"),               // DALL-E/Midjourney (optional)
  imagePrompt: text("image_prompt"),          // AI prompt for image generation
  audioUrl: text("audio_url"),              // ElevenLabs TTS URL
  musicUrl: text("music_url"),              // Suno music URL

  // GeoGebra
  geogebraConfig: jsonb("geogebra_config"), // GeoGebra XML/config

  // Quiz
  hasQuiz: boolean("has_quiz").notNull().default(false),
  quizType: text("quiz_type"),             // "multiple_choice" | "open_ended"

  // Timestamps
  createdAt: timestamp("created_at").notNull().defaultNow(),
  updatedAt: timestamp("updated_at")
    .notNull()
    .$onUpdate(() => new Date()),
});

export type InsertScene = typeof scenesTable.$inferInsert;
export type SelectScene = typeof scenesTable.$inferSelect;
```

#### quiz_questions
```typescript
export const quizQuestionsTable = pgTable("quiz_questions", {
  id: serial("id").primaryKey(),
  sceneId: integer("scene_id")
    .notNull()
    .references(() => scenesTable.id, { onDelete: "cascade" }),

  question: text("question").notNull(),
  type: text("type").notNull(),            // "multiple_choice" | "open_ended"

  // Multiple choice options (JSON array)
  options: jsonb("options"),               // ["A: option", "B: option", ...]

  // Answer
  correctAnswer: text("correct_answer").notNull(),
  explanation: text("explanation"),        // Optional explanation

  // Timestamps
  createdAt: timestamp("created_at").notNull().defaultNow(),
});

export type InsertQuizQuestion = typeof quizQuestionsTable.$inferInsert;
export type SelectQuizQuestion = typeof quizQuestionsTable.$inferSelect;
```

#### quiz_responses
```typescript
export const quizResponsesTable = pgTable("quiz_responses", {
  id: serial("id").primaryKey(),
  questionId: integer("question_id")
    .notNull()
    .references(() => quizQuestionsTable.id, { onDelete: "cascade" }),

  userId: integer("user_id")
    .notNull()
    .references(() => usersTable.id, { onDelete: "cascade" }),

  answer: text("answer").notNull(),
  isCorrect: boolean("is_correct").notNull(),

  answeredAt: timestamp("answered_at").notNull().defaultNow(),
});

export type InsertQuizResponse = typeof quizResponsesTable.$inferInsert;
export type SelectQuizResponse = typeof quizResponsesTable.$inferSelect;
```

#### playgrounds
```typescript
export const playgroundsTable = pgTable("playgrounds", {
  id: serial("id").primaryKey(),
  userId: integer("user_id")
    .notNull()
    .references(() => usersTable.id, { onDelete: "cascade" }),

  lessonId: integer("lesson_id").references(() => lessonsTable.id), // Optional

  name: text("name").notNull(),
  geogebraConfig: jsonb("geogebra_config").notNull(), // Saved GeoGebra state
  notes: text("notes"),                                // User notes

  createdAt: timestamp("created_at").notNull().defaultNow(),
  updatedAt: timestamp("updated_at")
    .notNull()
    .$onUpdate(() => new Date()),
});

export type InsertPlayground = typeof playgroundsTable.$inferInsert;
export type SelectPlayground = typeof playgroundsTable.$inferSelect;
```

#### shared_lessons
```typescript
export const sharedLessonsTable = pgTable("shared_lessons", {
  id: serial("id").primaryKey(),
  lessonId: integer("lesson_id")
    .notNull()
    .references(() => lessonsTable.id, { onDelete: "cascade" }),

  shareToken: text("share_token").notNull().unique(),
  viewCount: integer("view_count").notNull().default(0),

  createdAt: timestamp("created_at").notNull().defaultNow(),
  expiresAt: timestamp("expires_at"), // Optional: link expiration
});

export type InsertSharedLesson = typeof sharedLessonsTable.$inferInsert;
export type SelectSharedLesson = typeof sharedLessonsTable.$inferSelect;
```

### Indexes

```typescript
// Performance indexes
createIndex("lessons_user_id_idx").on(lessonsTable.userId);
createIndex("lessons_share_token_idx").on(lessonsTable.shareToken);
createIndex("scenes_lesson_id_idx").on(scenesTable.lessonId);
createIndex("quiz_questions_scene_id_idx").on(quizQuestionsTable.sceneId);
createIndex("quiz_responses_user_id_idx").on(quizResponsesTable.userId);
createIndex("playgrounds_user_id_idx").on(playgroundsTable.userId);
```

---

## API Design

### tRPC Router Structure

```typescript
// src/lib/server/routers/_app.ts
import { router } from "@/lib/server/trpc";
import { lessonsRouter } from "./lessons";
import { aiRouter } from "./ai";
import { mediaRouter } from "./media";
import { quizzesRouter } from "./quizzes";
import { playgroundsRouter } from "./playgrounds";
import { usersRouter } from "./users";

export const appRouter = router({
  lessons: lessonsRouter,
  ai: aiRouter,
  media: mediaRouter,
  quizzes: quizzesRouter,
  playgrounds: playgroundsRouter,
  users: usersRouter,
});

export type AppRouter = typeof appRouter;
```

### Lessons Router

```typescript
// src/lib/server/routers/lessons.ts
import { protectedProcedure, router } from "../trpc";
import { z } from "zod";
import { lessonsTable, scenesTable } from "@/lib/db/schema";

export const lessonsRouter = router({
  // Query: Get user's lessons
  getMyLessons: protectedProcedure
    .query(async ({ ctx }) => {
      return ctx.db.query.lessons.findMany({
        where: eq(lessonsTable.userId, ctx.session.user.id),
        orderBy: desc(lessonsTable.createdAt),
      });
    }),

  // Query: Get lesson by ID
  getById: protectedProcedure
    .input(z.object({ lessonId: z.number() }))
    .query(async ({ input, ctx }) => {
      const lesson = await ctx.db.query.lessons.findFirst({
        where: eq(lessonsTable.id, input.lessonId),
      });

      if (lesson.userId !== ctx.session.user.id) {
        throw new TRPCError({ code: "FORBIDDEN" });
      }

      return lesson;
    }),

  // Query: Get lesson with scenes
  getLessonWithScenes: protectedProcedure
    .input(z.object({ lessonId: z.number() }))
    .query(async ({ input, ctx }) => {
      const lesson = await ctx.db.query.lessons.findFirst({
        where: eq(lessonsTable.id, input.lessonId),
        with: {
          scenes: {
            orderBy: asc(scenesTable.sceneNumber),
          },
        },
      });

      if (lesson.userId !== ctx.session.user.id) {
        throw new TRPCError({ code: "FORBIDDEN" });
      }

      return lesson;
    }),

  // Mutation: Delete lesson
  delete: protectedProcedure
    .input(z.object({ lessonId: z.number() }))
    .mutation(async ({ input, ctx }) => {
      const lesson = await ctx.db.query.lessons.findFirst({
        where: eq(lessonsTable.id, input.lessonId),
      });

      if (lesson.userId !== ctx.session.user.id) {
        throw new TRPCError({ code: "FORBIDDEN" });
      }

      await ctx.db.delete(lessonsTable).where(eq(lessonsTable.id, input.lessonId));
      return { success: true };
    }),

  // Mutation: Share lesson
  share: protectedProcedure
    .input(z.object({ lessonId: z.number() }))
    .mutation(async ({ input, ctx }) => {
      const lesson = await ctx.db.query.lessons.findFirst({
        where: eq(lessonsTable.id, input.lessonId),
      });

      if (lesson.userId !== ctx.session.user.id) {
        throw new TRPCError({ code: "FORBIDDEN" });
      }

      const shareToken = generateShareToken();

      await ctx.db.update(lessonsTable)
        .set({ isPublic: true, shareToken })
        .where(eq(lessonsTable.id, input.lessonId));

      return { shareToken };
    }),
});
```

### AI Router

```typescript
// src/lib/server/routers/ai.ts
import { protectedProcedure, router } from "../trpc";
import { z } from "zod";
import { generateLesson } from "@/lib/ai/gemini/generators";
import { generateAudio } from "@/lib/ai/elevenlabs/client";
import { generateMusic } from "@/lib/ai/suno/client";

export const aiRouter = router({
  // Mutation: Generate complete lesson
  generateLesson: protectedProcedure
    .input(z.object({
      prompt: z.string().min(10).max(1000),
      complexity: z.enum(["elementary", "middle", "high"]),
    }))
    .mutation(async ({ input, ctx }) => {
      // 1. Generate lesson content
      const lessonData = await generateLesson({
        prompt: input.prompt,
        complexity: input.complexity,
      });

      // 2. Save to DB
      const lessonId = await saveLessonToDB(ctx.db, lessonData, ctx.session.user.id);

      return { lessonId, lesson: lessonData };
    }),

  // Mutation: Regenerate scene
  regenerateScene: protectedProcedure
    .input(z.object({
      sceneId: z.number(),
    }))
    .mutation(async ({ input, ctx }) => {
      // Fetch scene
      const scene = await ctx.db.query.scenes.findFirst({
        where: eq(scenesTable.id, input.sceneId),
      });

      if (!scene) {
        throw new TRPCError({ code: "NOT_FOUND" });
      }

      // Regenerate content
      const newContent = await generateSceneContent({
        lessonContext: scene.lessonId,
        sceneNumber: scene.sceneNumber,
      });

      // Update scene
      await ctx.db.update(scenesTable)
        .set(newContent)
        .where(eq(scenesTable.id, input.sceneId));

      return { scene: newContent };
    }),
});
```

### Quizzes Router

```typescript
// src/lib/server/routers/quizzes.ts
import { protectedProcedure, router } from "../trpc";
import { z } from "zod";
import { quizResponsesTable } from "@/lib/db/schema";
import { eq } from "drizzle-orm";

export const quizzesRouter = router({
  // Mutation: Submit quiz answer
  submitAnswer: protectedProcedure
    .input(z.object({
      questionId: z.number(),
      answer: z.string(),
    }))
    .mutation(async ({ input, ctx }) => {
      // Fetch question to get correct answer
      const question = await ctx.db.query.quizQuestions.findFirst({
        where: eq(quizQuestionsTable.id, input.questionId),
      });

      if (!question) {
        throw new TRPCError({ code: "NOT_FOUND" });
      }

      const isCorrect = input.answer.trim().toLowerCase() ===
        question.correctAnswer.trim().toLowerCase();

      // Save response
      await ctx.db.insert(quizResponsesTable).values({
        questionId: input.questionId,
        userId: ctx.session.user.id,
        answer: input.answer,
        isCorrect,
        answeredAt: new Date(),
      });

      return {
        isCorrect,
        explanation: question.explanation,
      };
    }),

  // Query: Get quiz responses for a lesson
  getResponses: protectedProcedure
    .input(z.object({ lessonId: z.number() }))
    .query(async ({ input, ctx }) => {
      const responses = await ctx.db.query.quizResponses.findMany({
        where: eq(quizResponsesTable.userId, ctx.session.user.id),
        with: {
          question: true,
        },
      });

      return responses;
    }),
});
```

### Playgrounds Router

```typescript
// src/lib/server/routers/playgrounds.ts
import { protectedProcedure, router } from "../trpc";
import { z } from "zod";
import { playgroundsTable } from "@/lib/db/schema";

export const playgroundsRouter = router({
  // Query: Get user's playgrounds
  getMyPlaygrounds: protectedProcedure.query(async ({ ctx }) => {
    return ctx.db.query.playgrounds.findMany({
      where: eq(playgroundsTable.userId, ctx.session.user.id),
      orderBy: desc(playgroundsTable.createdAt),
    });
  }),

  // Query: Get playground by ID
  getById: protectedProcedure
    .input(z.object({ playgroundId: z.number() }))
    .query(async ({ input, ctx }) => {
      const playground = await ctx.db.query.playgrounds.findFirst({
        where: eq(playgroundsTable.id, input.playgroundId),
      });

      if (playground.userId !== ctx.session.user.id) {
        throw new TRPCError({ code: "FORBIDDEN" });
      }

      return playground;
    }),

  // Mutation: Save playground state
  save: protectedProcedure
    .input(z.object({
      lessonId: z.number().optional(),
      name: z.string(),
      geogebraConfig: z.any(),
      notes: z.string().optional(),
    }))
    .mutation(async ({ input, ctx }) => {
      const [playground] = await ctx.db.insert(playgroundsTable).values({
        userId: ctx.session.user.id,
        lessonId: input.lessonId,
        name: input.name,
        geogebraConfig: input.geogebraConfig,
        notes: input.notes,
      }).returning();

      return playground;
    }),

  // Mutation: Update playground
  update: protectedProcedure
    .input(z.object({
      playgroundId: z.number(),
      geogebraConfig: z.any(),
      notes: z.string().optional(),
    }))
    .mutation(async ({ input, ctx }) => {
      const playground = await ctx.db.query.playgrounds.findFirst({
        where: eq(playgroundsTable.id, input.playgroundId),
      });

      if (playground.userId !== ctx.session.user.id) {
        throw new TRPCError({ code: "FORBIDDEN" });
      }

      await ctx.db.update(playgroundsTable)
        .set({
          geogebraConfig: input.geogebraConfig,
          notes: input.notes,
        })
        .where(eq(playgroundsTable.id, input.playgroundId));

      return { success: true };
    }),

  // Mutation: Delete playground
  delete: protectedProcedure
    .input(z.object({ playgroundId: z.number() }))
    .mutation(async ({ input, ctx }) => {
      const playground = await ctx.db.query.playgrounds.findFirst({
        where: eq(playgroundsTable.id, input.playgroundId),
      });

      if (playground.userId !== ctx.session.user.id) {
        throw new TRPCError({ code: "FORBIDDEN" });
      }

      await ctx.db.delete(playgroundsTable)
        .where(eq(playgroundsTable.id, input.playgroundId));

      return { success: true };
    }),
});
```

---

## External Service Integrations

### Google Gemini API

**Purpose:** Generate stories, scenes, GeoGebra XML, quiz questions, lyrics

**Integration:**
```typescript
// src/lib/ai/gemini/client.ts
import { GoogleGenerativeAI } from "@google/generative-ai";

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!);
const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash-exp" });

export { model };
```

**Key Prompts:**

1. **Lesson Outline Generation**
```
Generate a lesson outline for {topic} at {complexity} level.
Return JSON structure with:
- 5-7 scenes
- Each scene: title, content summary, key concepts
- Quiz questions for scenes 3 and 6
- GeoGebra concepts for scene 4
```

2. **Scene Content Generation**
```
Generate scene content for {sceneTitle}.
Context: {previousScenes}
Target age: {complexity}
Output: Engaging story text (150-200 words)
```

3. **GeoGebra XML Generation**
```
Generate GeoGebra applet XML for {concept}.
Include:
- Interactive elements
- Labels and measurements
- Animation if applicable
```

4. **Quiz Generation**
```
Generate quiz question for {sceneContent}.
Output JSON:
{
  question: "...",
  type: "multiple_choice" | "open_ended",
  options: ["A", "B", "C"],
  correctAnswer: "B",
  explanation: "..."
}
```

5. **Lyrics Generation**
```
Generate lyrics for {sceneContent}.
Style: Educational, {complexity} level
Length: 2-3 verses
```

**Rate Limits & Cost:**
- Free tier: 15 queries/min, 1,500/day
- Pay-as-you-go: $0.001 per 1K chars
- Flash model: $0.075 per 1M tokens

**Error Handling:**
- Implement exponential backoff for rate limits
- Cache responses in DB
- Fallback to generic prompts if specific context fails

---

### ElevenLabs (Text-to-Speech)

**Purpose:** High-quality narration for story scenes

**Integration:**
```typescript
// src/lib/ai/elevenlabs/client.ts
import axios from "axios";

const ELEVENLABS_API_URL = "https://api.elevenlabs.io/v1";

export async function generateAudio({
  text,
  voiceId = "21m00Tcm4TlvDq8ikWAM", // Default: "Rachel"
  modelId = "eleven_multilingual_v2",
}) {
  const response = await axios.post(
    `${ELEVENLABS_API_URL}/text-to-speech/${voiceId}`,
    {
      text,
      model_id: modelId,
      voice_settings: {
        stability: 0.5,
        similarity_boost: 0.75,
      },
    },
    {
      headers: {
        "xi-api-key": process.env.ELEVENLABS_API_KEY,
        "Content-Type": "application/json",
      },
      responseType: "arraybuffer",
    }
  );

  return response.data; // Audio buffer
}

export async function uploadToStorage(audioBuffer: Buffer): Promise<string> {
  // Upload to cloud storage (Vercel Blob, AWS S3, etc.)
  // Return public URL
}
```

**Voice Configuration:**
- **Primary Voice:** "Rachel" (21m00Tcm4TlvDq8ikWAM) - Clear, educational tone
- **Backup Voice:** "Elli" (MF3mGyEYCl7XY6bVhlVz) - Friendly, younger tone
- **Language:** English (US)

**Rate Limits & Cost:**
- Free tier: 10,000 chars/month
- Starter: $22/mo, 30,000 chars
- Pay-per-char: $0.30 per 1K chars

**Strategy:**
- Generate audio during lesson creation (not on scene load)
- Cache URLs in DB
- Reuse for repeated lessons

---

### Suno AI (Music Generation)

**Purpose:** Scene-specific background music

**Integration:**
```typescript
// src/lib/ai/suno/client.ts
import axios from "axios";

const SUNO_API_URL = "https://api.sunoapi.org";

export async function generateMusic({
  prompt,
  style = "educational, ambient, instrumental",
  duration = 30, // seconds
}): Promise<string> {
  // 1. Start generation
  const { data: response } = await axios.post(
    `${SUNO_API_URL}/generate`,
    {
      prompt: `${prompt}, ${style}`,
      make_instrumental: true,
      duration,
    },
    {
      headers: {
        "Authorization": `Bearer ${process.env.SUNO_API_KEY}`,
      },
    }
  );

  const taskId = response.task_id;

  // 2. Poll for completion
  let result = await pollTaskStatus(taskId);

  // 3. Return audio URL
  return result.audio_url;
}

async function pollTaskStatus(taskId: string) {
  const maxAttempts = 60; // 5 minutes
  let attempts = 0;

  while (attempts < maxAttempts) {
    const { data } = await axios.get(`${SUNO_API_URL}/task/${taskId}`);

    if (data.status === "completed") {
      return data;
    }

    await sleep(5000); // Wait 5 seconds
    attempts++;
  }

  throw new Error("Music generation timeout");
}
```

**Prompt Engineering:**
```
Style options:
- Elementary: "light, playful, simple, children's music"
- Middle: "upbeat, energetic, moderate complexity"
- High: "dramatic, cinematic, orchestral"
```

**Rate Limits & Cost:**
- Free tier: Limited generations
- Basic: $10/mo, 50 songs
- Pro: $30/mo, unlimited

**Strategy:**
- Generate shorter clips (30-45s) to save costs
- Loop music on client side
- Generate during lesson creation

---

### GeoGebra Embedding

**Purpose:** Interactive mathematical visualizations

**Integration:**
```typescript
// src/components/playground/geogebra-embed.tsx
"use client";

import { useEffect, useRef } from "react";
import Geogebra from "react-geogebra";

interface GeoGebraEmbedProps {
  config: {
    appName: "graphing" | "geometry" | "classic";
    width: number;
    height: number;
    showToolBar: boolean;
    showAlgebraInput: boolean;
    showMenuBar: boolean;
    material_id?: string; // Pre-made material
    ggbBase64?: string; // Base64-encoded GGB file
    filename?: string; // URL to GGB file
  };
  onReady?: () => void;
  onChange?: (state: any) => void;
}

export function GeoGebraEmbed({ config, onReady, onChange }: GeoGebraEmbedProps) {
  const containerRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    // Load GeoGebra script if not present
    if (!document.querySelector('script[src*="deployggb.js"]')) {
      const script = document.createElement("script");
      script.src = "https://www.geogebra.org/apps/deployggb.js";
      script.async = true;
      document.head.appendChild(script);
    }
  }, []);

  return (
    <div ref={containerRef}>
      <Geogebra
        {...config}
        onReady={() => {
          console.log("GeoGebra ready");
          onReady?.();
        }}
        onUpdate={(state) => {
          // Capture GeoGebra state for saving
          onChange?.(state);
        }}
      />
    </div>
  );
}
```

**GeoGebra Configuration from Gemini:**
```json
{
  "appName": "graphing",
  "width": 800,
  "height": 600,
  "showToolBar": true,
  "showAlgebraInput": true,
  "showMenuBar": false,
  "ggbBase64": "<base64-encoded GGB file>"
}
```

**State Management:**
- Capture state on user interaction
- Save to DB via playgrounds table
- Restore on page load

---

## Security & Authentication

### Authentication Flow

```
User Sign Up/Login
       ↓
Better Auth (email/password or Google OAuth)
       ↓
Session token created
       ↓
tRPC middleware validates token
       ↓
User context available in procedures
```

### Middleware Implementation

```typescript
// src/lib/server/trpc.ts
import { initTRPC, TRPCError } from "@trpc/server";
import { auth } from "@/lib/auth";

const t = initTRPC.context<Context>().create();

const enforceUserIsAuthed = t.middleware(({ ctx, next }) => {
  if (!ctx.session) {
    throw new TRPCError({ code: "UNAUTHORIZED" });
  }

  return next({
    ctx: {
      ...ctx,
      session: { ...ctx.session, user: ctx.session.user },
    },
  });
});

export const protectedProcedure = t.procedure.use(enforceUserIsAuthed);
```

### Data Protection

1. **Input Validation:**
   - All inputs validated with Zod schemas
   - Sanitize user prompts (prevent XSS)

2. **Row-Level Security:**
   - Users can only access their own lessons
   - Shared lessons have separate access control

3. **API Keys:**
   - Never expose in client code
   - Store in environment variables
   - Use different keys for dev/staging/production

4. **Content Moderation:**
   - Use Gemini's safety filters
   - Flag inappropriate content
   - Allow manual review

---

## State Management

### Client-Side State

**React Hooks:**
- `useLesson`: Lesson loading, navigation
- `useScene`: Scene state, auto-advance
- `useTTS`: Audio playback controls
- `useQuiz`: Quiz answers, validation
- `useGeogebra`: GeoGebra interactions
- `useShare`: Share link generation

**TanStack Query:**
```typescript
// Fetch lesson
const { data: lesson, isLoading } = trpc.lessons.getLessonWithScenes.useQuery(
  { lessonId },
  { enabled: !!lessonId }
);

// Generate lesson
const generateMutation = trpc.ai.generateLesson.useMutation({
  onSuccess: (data) => {
    router.push(`/lesson/${data.lessonId}`);
  },
});
```

### Server-Side State

**tRPC Context:**
```typescript
// src/lib/trpc/context.ts
export const createTRPCContext = cache(async () => {
  const session = await auth.api.getSession({
    headers: headers(),
  });

  return {
    db,
    session,
    headers: headers(),
  };
});
```

---

## Performance & Optimization

### Caching Strategy

1. **AI-Generated Content:**
   - Cache in DB (lessons, scenes)
   - Generate once, reuse forever
   - Implement LRU cache for Gemini responses

2. **Media Assets:**
   - Upload to CDN (Vercel Blob, Cloudflare R2)
   - Cache headers: 30 days
   - Lazy load images/audio

3. **tRPC Queries:**
   - TanStack Query caching (staleTime: 5min)
   - Prefetch next scene
   - Optimistic updates for quiz answers

### Optimizations

1. **Code Splitting:**
   - Dynamic imports for heavy components (GeoGebra)
   - Route-based splitting

2. **Image Optimization:**
   - Next.js Image component
   - WebP format
   - Lazy loading

3. **Audio Streaming:**
   - Stream TTS audio (don't wait for full generation)
   - Progressive playback

4. **Database:**
   - Indexed columns
   - Connection pooling (Neon serverless)
   - Query batching

---

## Deployment Architecture

### Production Stack

```
┌─────────────────────────────────────────────────┐
│            Vercel (or Railway)             │
│                                             │
│  ┌─────────────────────────────────────┐      │
│  │   Next.js App (Serverless)       │      │
│  │                                     │      │
│  │  - API Routes (tRPC)              │      │
│  │  - Server Components              │      │
│  │  - Static Assets                 │      │
│  └─────────────────────────────────────┘      │
│                    │                          │
│         ┌──────────┴──────────┐             │
│         │                     │             │
│  ┌──────▼──────┐    ┌──────▼──────┐      │
│  │   Neon DB    │    │  Vercel Blob │      │
│  │ (PostgreSQL) │    │  (CDN)       │      │
│  └─────────────┘    └───────────────┘      │
│                                             │
│  External APIs:                               │
│  • Gemini                                    │
│  • ElevenLabs                                │
│  • Suno                                      │
│  • GeoGebra CDN                               │
└─────────────────────────────────────────────────┘
```

### Environment Variables

```bash
# Database
DATABASE_URL=postgresql://...

# Auth
BETTER_AUTH_SECRET=...
BETTER_AUTH_URL=...
GOOGLE_CLIENT_ID=...
GOOGLE_CLIENT_SECRET=...

# AI Services
GEMINI_API_KEY=...
ELEVENLABS_API_KEY=...
SUNO_API_KEY=...

# Storage
VERCEL_BLOB_TOKEN=... (or AWS credentials)

# Deployment
NEXT_PUBLIC_APP_URL=https://...
```

### CI/CD Pipeline

1. **Git Push → GitHub Actions**
2. **Run Tests** (Jest/Vitest)
3. **Lint & Type Check** (Biome, tsc)
4. **Build** (`next build`)
5. **Deploy** (Vercel/Railway)
6. **Run Migrations** (`pnpm db:migrate`)

---

## Cost Analysis

### Per-Lesson Generation Cost Breakdown

| Component | Usage | Cost (Estimate) |
|-----------|--------|-----------------|
| **Gemini (Content)** | ~10K tokens | $0.001 |
| **Gemini (GeoGebra XML)** | ~2K tokens | $0.0002 |
| **ElevenLabs (TTS)** | ~5K chars × 5 scenes | $0.75 |
| **Suno (Music)** | 5 scenes × 30s | $1.00 |
| **Storage (CDN)** | ~5MB total | $0.01 |
| **Total** | - | **~$1.76** |

### Monthly Cost Estimates (100 active users)

| Item | Usage | Cost |
|------|--------|------|
| Neon DB | 1GB storage | Free |
| Vercel Hosting | 100GB bandwidth | $20 |
| Vercel Blob | 10GB storage | $5 |
| ElevenLabs | 100 lessons × $0.75 | $75 |
| Suno | 100 lessons × $1.00 | $100 |
| Gemini | 1M tokens | $1.00 |
| **Total** | - | **~$201/month** |

### Optimization Strategies

1. **Reuse Content:**
   - Generate once, share across users
   - Public gallery of templates

2. **Reduce TTS Cost:**
   - Use Web Speech API for preview
   - ElevenLabs only for final generation

3. **Optimize Music:**
   - Shorter clips (20s)
   - Loop on client
   - Use royalty-free library for generic scenes

---

## Development Workflow

### Local Development

```bash
# Install dependencies
pnpm install

# Setup database
cp .env.example .env.local
# Edit .env.local with credentials

# Run migrations
pnpm db:migrate

# Start dev server
pnpm dev
```

### Database Commands

```bash
# Generate schema from code
pnpm db:generate

# Apply migrations
pnpm db:migrate

# Reset database (dev only)
pnpm db:drop && pnpm db:migrate

# Open Drizzle Studio
pnpm db:studio
```

### Code Quality

```bash
# Lint
pnpm lint

# Fix linting issues
pnpm lint:fix

# Format code
pnpm format
```

### Git Workflow

```bash
# Feature branch
git checkout -b feature/lesson-generation

# Commit with conventional commits
git commit -m "feat: add lesson generation endpoint"

# Pre-commit hooks run automatically (Husky)
# - Lint
# - Type check
```

---

## Appendix

### Type Definitions

```typescript
// src/types/lesson.ts
export interface Lesson {
  id: number;
  userId: number;
  title: string;
  subject: string;
  topic: string;
  complexity: "elementary" | "middle" | "high";
  userPrompt: string;
  isPublic: boolean;
  shareToken?: string;
  scenes: Scene[];
  createdAt: Date;
  updatedAt: Date;
}

export interface Scene {
  id: number;
  lessonId: number;
  sceneNumber: number;
  title: string;
  content: string;
  imageUrl?: string;
  audioUrl?: string;
  musicUrl?: string;
  geogebraConfig?: any;
  hasQuiz: boolean;
  quizType?: "multiple_choice" | "open_ended";
  createdAt: Date;
}

export interface QuizQuestion {
  id: number;
  sceneId: number;
  question: string;
  type: "multiple_choice" | "open_ended";
  options?: string[];
  correctAnswer: string;
  explanation?: string;
}
```

### Constants

```typescript
// src/lib/utils/constants.ts
export const COMPLEXITY_LEVELS = {
  ELEMENTARY: "elementary",
  MIDDLE: "middle",
  HIGH: "high",
} as const;

export const MAX_SCENES = 10;
export const MIN_SCENES = 3;
export const MIN_PROMPT_LENGTH = 10;
export const MAX_PROMPT_LENGTH = 1000;

export const TTS_VOICE = {
  PRIMARY: "21m00Tcm4TlvDq8ikWAM", // Rachel
  BACKUP: "MF3mGyEYCl7XY6bVhlVz", // Elli
};

export const GEEOGBRA_APPS = {
  GRAPHING: "graphing",
  GEOMETRY: "geometry",
  CLASSIC: "classic",
  GRAPHING_3D: "graphing3d",
} as const;
```

### Error Codes

```typescript
// src/lib/utils/errors.ts
export const ERROR_CODES = {
  LESSON_NOT_FOUND: "LESSON_NOT_FOUND",
  GENERATION_FAILED: "GENERATION_FAILED",
  TTS_FAILED: "TTS_FAILED",
  MUSIC_FAILED: "MUSIC_FAILED",
  GEOGEBRA_FAILED: "GEOGEBRA_FAILED",
  UNAUTHORIZED: "UNAUTHORIZED",
  FORBIDDEN: "FORBIDDEN",
} as const;
```

---

**Document End**
